<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.september.sunrise.kk.mapper.KkFundLogMapper">

	<!-- 插入资金流水 -->
	<insert id="insertFundLog" parameterType="com.september.sunrise.kk.domain.KkFundLog">
		INSERT INTO kk_fund_log (
			ref_id, ref_type, user_id, user_role,
			flow_type, amount, balance_after, remark, create_time
		) VALUES (
					 #{refId}, #{refType}, #{userId}, #{userRole},
					 #{flowType}, #{amount}, #{balanceAfter}, #{remark}, NOW()
				 )
	</insert>

	<!-- 查询流水 -->
	<select id="queryFundLogs" parameterType="map" resultType="com.september.sunrise.kk.domain.KkFundLog">
		SELECT * FROM kk_fund_log
		WHERE 1=1
		<if test="userId != null">
			AND user_id = #{userId}
		</if>
		<if test="role != null">
			AND user_role = #{role}
		</if>
		<if test="startTime != null">
			AND create_time <![CDATA[ >= ]]> #{startTime}
		</if>
		<if test="endTime != null">
			AND create_time <![CDATA[ <= ]]> #{endTime}
		</if>
		ORDER BY id DESC
	</select>

	<!-- 统计汇总金额 -->
	<select id="sumAmount" resultType="java.math.BigDecimal">
		SELECT COALESCE(SUM(amount), 0)
		FROM kk_fund_log
		WHERE user_id = #{userId} AND user_role = #{role} AND flow_type = #{flowType}
		<if test="startTime != null">
			AND create_time <![CDATA[ >= ]]> #{startTime}
		</if>
		<if test="endTime != null">
			AND create_time <![CDATA[ <= ]]> #{endTime}
		</if>
	</select>

</mapper>
